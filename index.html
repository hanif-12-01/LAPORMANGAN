<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Lapor Mangan! - Purwokerto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --red: #c53e4e;
      --light-red: #d8c2cf;
      --bg: #f8f9fa;
      --white: #ffffff;
      --text: #333;
      --blue: #2980b9;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; }
    body { background: var(--bg); color: var(--text); }

    header {
      background: var(--red);
      color: var(--white);
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      position: relative;
    }

    .header-content {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
    }

    header img { height: 40px; }

    .weather-info {
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 12px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
    }

    .weather-info:hover { background: rgba(255, 255, 255, 0.3); }

    .weather-icon { font-size: 20px; }
    .weather-temp { font-weight: 600; font-size: 16px; }

    .weather-details {
      position: absolute;
      top: 100%;
      right: 20px;
      background: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      z-index: 1000;
      width: 250px;
      display: none;
      color: var(--text);
    }

    .weather-details.show { display: block; animation: fadeIn 0.3s ease; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    #map { height: 60vh; width: 100%; }

    .container {
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }

    .filter-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .filter-bar input,
    .filter-bar select,
    .filter-bar button,
    .filter-bar a.lapor-button {
      flex: 1;
      padding: 10px;
      border: 1px solid var(--light-red);
      border-radius: 8px;
    }

    .filter-bar button {
      background: var(--red);
      color: white;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .filter-bar button:hover { background: #b03545; }

    .lapor-button {
      background: var(--blue);
      color: white;
      cursor: pointer;
      transition: background 0.3s ease;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-weight: 500;
    }

    .lapor-button:hover { background: #2471a3; }

    .card {
      background: var(--white);
      border-left: 5px solid var(--red);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .card:hover { transform: translateY(-3px); }

    .card h3 { color: var(--red); }
    .card small { color: #666; }

    .detail-popup {
      display: none;
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      z-index: 9999;
      max-width: 400px;
      width: 90%;
    }

    .detail-popup img {
      width: 100%;
      border-radius: 8px;
      margin-top: 10px;
    }

    .close-btn {
      float: right;
      cursor: pointer;
      font-size: 20px;
      color: var(--red);
    }

    .chatbot {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--red);
      color: white;
      border-radius: 50%;
      padding: 15px;
      cursor: pointer;
      z-index: 999;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      transition: transform 0.3s ease;
    }

    .chatbot:hover { transform: scale(1.1); }

    .chat-popup {
      display: none;
      position: fixed;
      bottom: 80px;
      right: 20px;
      background: white;
      border-radius: 15px;
      width: 300px;
      height: 400px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      overflow: hidden;
      flex-direction: column;
      z-index: 999;
    }

    .chat-header {
      background: #00B900;
      color: white;
      padding: 12px 15px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-close { cursor: pointer; font-size: 20px; }

    .chat-messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #e5ddd5;
      background-image: url('https://web.line.me/static/desktop/2.1.0/img/bg_chat.5f8e3b6.png');
      background-size: cover;
      scroll-behavior: smooth;
    }

    .message {
      margin-bottom: 10px;
      max-width: 80%;
      padding: 8px 12px;
      border-radius: 18px;
      line-height: 1.4;
      word-wrap: break-word;
    }

    .message-user {
      background: #DCF8C6;
      margin-left: auto;
      margin-right: 5px;
      border-top-right-radius: 5px;
    }

    .message-bot {
      background: white;
      margin-right: auto;
      margin-left: 5px;
      border-top-left-radius: 5px;
    }

    .typing-indicator {
      background: white !important;
      margin-right: auto;
      margin-left: 5px;
      border-top-left-radius: 5px;
      padding: 12px 16px;
    }

    .typing-dots {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .typing-dots span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #999;
      animation: typing 1.4s infinite ease-in-out;
    }

    @keyframes typing {
      0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }

    .message-time {
      font-size: 10px;
      color: #666;
      margin-top: 3px;
      text-align: right;
    }

    .chat-input-container {
      display: flex;
      padding: 10px;
      background: white;
      border-top: 1px solid #ddd;
    }

    .chat-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 20px;
      outline: none;
    }

    .chat-send {
      background: #00B900;
      color: white;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      margin-left: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @media (max-width: 768px) {
      header { flex-direction: column; align-items: flex-start; }
      .weather-info { margin-top: 10px; align-self: flex-end; }
      .weather-details { right: 10px; left: 10px; width: auto; }
      .filter-bar { flex-direction: column; }
      .detail-popup { top: 5%; }
      .chat-popup { width: 90%; right: 5%; bottom: 70px; }
    }

    @media (max-width: 480px) {
      .header-content h1 { font-size: 20px; }
      .weather-info { padding: 6px 10px; font-size: 14px; }
    }
  </style>
</head>
<body>

  <header>
    <div class="header-content">
      <img src="Gambar_WhatsApp_2025-07-27_pukul_16.37.41_d81d9ca4-removebg-preview.png" alt="Lapor Mangan Logo" style="height: 50px; margin-right: 15px;">
    </div>
    
    <div class="weather-info" id="weatherInfo" onclick="toggleWeatherDetails()">
      <i class="fas fa-cloud-sun weather-icon" id="weatherIcon"></i>
      <span class="weather-temp" id="weatherTemp">--°C</span>
    </div>
    
    <div class="weather-details" id="weatherDetails">
      <div class="weather-details-header">
        <h3>Cuaca Purwokerto</h3>
        <small id="weatherDate">Hari ini</small>
      </div>
      <div class="weather-details-main">
        <i class="fas fa-cloud-sun weather-details-icon" id="weatherDetailsIcon"></i>
        <div>
          <div class="weather-details-temp" id="weatherDetailsTemp">--°C</div>
          <div class="weather-details-desc" id="weatherDetailsDesc">--</div>
        </div>
      </div>
      <div class="weather-details-stats">
        <div class="weather-stat"><i class="fas fa-temperature-low"></i><span>Min: <span id="weatherMinTemp">--°C</span></span></div>
        <div class="weather-stat"><i class="fas fa-temperature-high"></i><span>Max: <span id="weatherMaxTemp">--°C</span></span></div>
        <div class="weather-stat"><i class="fas fa-tint"></i><span>Kelembapan: <span id="weatherHumidity">--%</span></span></div>
        <div class="weather-stat"><i class="fas fa-wind"></i><span>Angin: <span id="weatherWind">-- m/s</span></span></div>
      </div>
    </div>
  </header>

  <div id="map"></div>

  <div class="container">
    <div class="filter-bar">
      <input id="search" placeholder="Cari nama kuliner..." />
      <select id="filter">
        <option value="">Semua</option>
        <option value="Soto">Soto</option>
        <option value="Gorengan">Gorengan</option>
        <option value="Jajanan Tradisional">Jajanan Tradisional</option>
        <option value="Camilan Kering">Camilan Kering</option>
        <option value="Kue Tradisional">Kue Tradisional</option>
        <option value="Kuliner Unik">Kuliner Unik</option>
        <option value="Sayuran">Sayuran</option>
        <option value="Dodol">Dodol</option>
        <option value="Kue Kering">Kue Kering</option>
        <option value="Makanan Ringan">Makanan Ringan</option>
        <option value="Camilan">Camilan</option>
        <option value="Camilan Manis">Camilan Manis</option>
        <option value="Minuman">Minuman</option>
      </select>
      <button onclick="showWeatherRec()">Rekomendasi Cuaca</button>
      <a href="https://docs.google.com/forms/d/e/1FAIpQLScJ8tkZau-NVdhbmd0cWFKY25VBm0Ajjxvqo-rLYAO_iGb2qg/viewform?usp=dialog" target="_blank" class="lapor-button">
        <i class="fas fa-plus-circle"></i> Lapor
      </a>
    </div>

    <div id="list"></div>
  </div>

  <div class="detail-popup" id="detailPopup">
    <span class="close-btn" onclick="closeDetail()">×</span>
    <div id="detailContent"></div>
  </div>

  <div class="chatbot" onclick="toggleChat()">💬</div>
  <div class="chat-popup" id="chatPopup">
    <div class="chat-header">
      <span>MakanBot</span>
      <span class="chat-close" onclick="toggleChat()">×</span>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="message message-bot">
        Halo! Ada yang bisa saya bantu cari kuliner di Purwokerto?
        <div class="message-time">8:23 PM</div>
      </div>
    </div>
    <div class="chat-input-container">
      <input type="text" class="chat-input" id="chatInput" placeholder="Ketik pesan..." onkeypress="if(event.key=='Enter') sendChat()">
      <button class="chat-send" onclick="sendChat()">➤</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const kulinerData = [
      { nama: "Soto Sokaraja", kategori: "Soto", alamat: "Jl. Sokaraja, Purwokerto", jam: "07:00 - 15:00", harga: "Rp 12.000 - 20.000", deskripsi: "Kuah kaldu sapi + kacang, disajikan dengan ketupat dan kerupuk.", foto: "https://i.imgur.com/8z3L5kL.jpg", parkir: "Tersedia", rute: "Area Sokaraja", lat: -7.4220, lng: 109.2300, keliling: false },
      { nama: "Tempe Mendoan", kategori: "Gorengan", alamat: "Pasar Sokaraja, Purwokerto", jam: "06:00 - 18:00", harga: "Rp 2.000 - 5.000", deskripsi: "Tempe digoreng setengah matang, renyah di luar lembut di dalam.", foto: "https://i.imgur.com/8z3L5kL.jpg", parkir: "Tersedia", rute: "Pasar Sokaraja", lat: -7.4200, lng: 109.2300, keliling: true },
      { nama: "Getuk Goreng", kategori: "Jajanan Tradisional", alamat: "Jl. Sudirman, Purwokerto", jam: "08:00 - 17:00", harga: "Rp 5.000 - 10.000", deskripsi: "Singkong digoreng, isi gula aren, renyah di luar lembut di dalam.", foto: "https://i.imgur.com/8z3L5kL.jpg", parkir: "Ya", rute: "Jl. Sudirman - Alun-Alun", lat: -7.4210, lng: 109.2400, keliling: true },
      { nama: "Klanting", kategori: "Camilan Kering", alamat: "Pasar Baru, Purwokerto", jam: "09:00 - 17:00", harga: "Rp 5.000 - 10.000", deskripsi: "Cemilan singkong berbentuk anting, asin gurih.", foto: "https://i.imgur.com/8z3L5kL.jpg", parkir: "Ya", rute: "Pasar Baru - Terminal", lat: -7.4250, lng: 109.2350, keliling: true },
      { nama: "Cenil", kategori: "Jajanan Tradisional", alamat: "Jl. Dr. Soeparno, Purwokerto", jam: "08:00 - 16:00", harga: "Rp 3.000 - 5.000", deskripsi: "Singkong berwarna-warni, kenyal, ditaburi kelapa.", foto: "https://i.imgur.com/8z3L5kL.jpg", parkir: "Tidak", rute: "Sekitar kampus UNSOED", lat: -7.4300, lng: 109.2450, keliling: true },
      { nama: "Nopia", kategori: "Kue Tradisional", alamat: "Jl. Sudirman, Purwokerto", jam: "07:00 - 18:00", harga: "Rp 3.000 - 6.000", deskripsi: "Kue isi gula merah, kacang, atau cokelat, dipanggang di tungku.", foto: "https://i.imgur.com/8z3L5kL.jpg", parkir: "Ya", rute: "Jl. Sudirman - Pasar Wage", lat: -7.4180, lng: 109.2380, keliling: true },
      { nama: "Kraca", kategori: "Kuliner Unik", alamat: "Pasar Malam Purwokerto", jam: "18:00 - 23:00", harga: "Rp 8.000 - 12.000", deskripsi: "Keong kecil dimasak pedas, dijual di pinggir jalan malam.", foto: "https://i.imgur.com/8z3L5kL.jpg", parkir: "Tidak", rute: "Pasar Malam - Alun-Alun", lat: -7.4200, lng: 109.2500, keliling: true },
      { nama: "Kuluban / Kluban", kategori: "Sayuran", alamat: "Jl. HR Bunyamin, Purwokerto", jam: "10:00 - 15:00", harga: "Rp 8.000 - 12.000", deskripsi: "Sayuran rebus + sambal kelapa, mirip salad.", foto: "https://i.imgur.com/8z3L5kL.jpg", parkir: "Ya", rute: "Jl. HR Bunyamin - Pasar Kliwon", lat: -7.4160, lng: 109.2320, keliling: false },
      { nama: "Jenang Jaket", kategori: "Dodol", alamat: "Pasar Wage, Purwokerto", jam: "08:00 - 16:00", harga: "Rp 5.000 - 10.000", deskripsi: "Tepung ketan + santan + gula merah, lembut dan manis.", foto: "https://i.imgur.com/8z3L5kL.jpg", parkir: "Ya", rute: "Pasar Wage - Terminal", lat: -7.4270, lng: 109.2400, keliling: true },
      { nama: "Jalabiya", kategori: "Kue Kering", alamat: "Jl. Pramuka, Purwokerto", jam: "09:00 - 17:00", harga: "Rp 4.000 - 7.000", deskripsi: "Singkong isi gula merah, bentuk seperti donat.", foto: "https://i.imgur.com/8z3L5kL.jpg", parkir: "Tidak", rute: "Jl. Pramuka - Pasar Baru", lat: -7.4220, lng: 109.2360, keliling: true },
      { nama: "Sahoun", kategori: "Makanan Ringan", alamat: "Jl. Gatot Subroto, Purwokerto", jam: "10:00 - 16:00", harga: "Rp 8.000 - 12.000", deskripsi: "Soun berkuah ayam, kenyal dan gurih.", foto: "https://i.imgur.com/8z3L5kL.jpg", parkir: "Ya", rute: "Jl. Gatot Subroto - Kampus UNSOED", lat: -7.4190, lng: 109.2320, keliling: false },
      { nama: "Wajik Kletik", kategori: "Camilan Manis", alamat: "Jl. Dr. Cipto, Purwokerto", jam: "08:00 - 17:00", harga: "Rp 3.000 - 6.000", deskripsi: "Wajik kenyal dari gula jawa.", foto: "https://i.imgur.com/8z3L5kL.jpg", parkir: "Tidak", rute: "Jl. Dr. Cipto - Pasar Kliwon", lat: -7.4240, lng: 109.2380, keliling: true },
      { nama: "Combro", kategori: "Camilan", alamat: "Jl. HR Bunyamin, Purwokerto", jam: "07:00 - 18:00", harga: "Rp 3.000 - 5.000", deskripsi: "Singkong isi oncom pedas, goreng renyah.", foto: "https://i.imgur.com/8z3L5kL.jpg", parkir: "Ya", rute: "Jl. HR Bunyamin - Alun-Alun", lat: -7.4180, lng: 109.2300, keliling: true },
      { nama: "Lumpia Boom", kategori: "Makanan Ringan", alamat: "Jl. Sudirman, Purwokerto", jam: "09:00 - 18:00", harga: "Rp 10.000 - 15.000", deskripsi: "Lumpia besar isi sayur, telur, ayam, dll.", foto: "https://i.imgur.com/8z3L5kL.jpg", parkir: "Ya", rute: "Jl. Sudirman - Pasar Wage", lat: -7.4210, lng: 109.2410, keliling: true },
      { nama: "Cimplung", kategori: "Camilan", alamat: "Jl. Pramuka, Purwokerto", jam: "08:00 - 16:00", harga: "Rp 3.000 - 5.000", deskripsi: "Singkong + kelapa + gula aren, manis dan gurih.", foto: "https://i.imgur.com/8z3L5kL.jpg", parkir: "Tidak", rute: "Jl. Pramuka - Terminal", lat: -7.4250, lng: 109.2340, keliling: true },
      // Tambahan dari Wikipedia 
      { nama: "Tahu Brontak", kategori: "Gorengan", alamat: "Pasar Sokaraja, Purwokerto", jam: "08:00 - 17:00", harga: "Rp 3.000 - 6.000", deskripsi: "Tahu isi sayuran yang keluar saat digoreng, gurih dan renyah.", foto: "https://i.imgur.com/8z3L5kL.jpg", parkir: "Ya", rute: "Pasar Sokaraja", lat: -7.4205, lng: 109.2295, keliling: true },
      { nama: "Dage", kategori: "Camilan Kering", alamat: "Jl. Sudirman, Purwokerto", jam: "09:00 - 16:00", harga: "Rp 5.000 - 8.000", deskripsi: "Kudapan dari ampas kacang yang digumpalkan dan dijamurkan, disantap dengan cabe rawit.", foto: "https://i.imgur.com/8z3L5kL.jpg", parkir: "Ya", rute: "Jl. Sudirman", lat: -7.4215, lng: 109.2415, keliling: true },
      { nama: "Empal Basah", kategori: "Makanan Berat", alamat: "Warung Empal Bu Yati, Purwokerto", jam: "10:00 - 20:00", harga: "Rp 15.000 - 25.000", deskripsi: "Daging sapi kuah santan kental dengan sensasi gatal dari serunding, cocok dengan ketupat janur.", foto: "https://i.imgur.com/8z3L5kL.jpg", parkir: "Ya", rute: "Jl. HR Bunyamin", lat: -7.4175, lng: 109.2315, keliling: false },
      { nama: "Dawet Ayu", kategori: "Minuman", alamat: "Pasar Wage, Purwokerto", jam: "08:00 - 17:00", harga: "Rp 5.000 - 8.000", deskripsi: "Minuman segar dari cendol, santan, dan gula jawa, disajikan dengan es.", foto: "https://i.imgur.com/8z3L5kL.jpg", parkir: "Ya", rute: "Pasar Wage", lat: -7.4275, lng: 109.2405, keliling: true }
    ];

    const map = L.map('map').setView([-7.4212, 109.2422], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    let markers = [];

    const API_KEY = '360cd1393e0f16a61618fd4e441a39b8';
    const PURWOKERTO_LAT = -7.4212;
    const PURWOKERTO_LON = 109.2422;

    const weatherIcons = {
      '01d': 'fas fa-sun', '01n': 'fas fa-moon', '02d': 'fas fa-cloud-sun', '02n': 'fas fa-cloud-moon',
      '03d': 'fas fa-cloud', '03n': 'fas fa-cloud', '04d': 'fas fa-cloud', '04n': 'fas fa-cloud',
      '09d': 'fas fa-cloud-rain', '09n': 'fas fa-cloud-rain', '10d': 'fas fa-cloud-sun-rain',
      '10n': 'fas fa-cloud-moon-rain', '11d': 'fas fa-bolt', '11n': 'fas fa-bolt',
      '13d': 'fas fa-snowflake', '13n': 'fas fa-snowflake', '50d': 'fas fa-smog', '50n': 'fas fa-smog'
    };

    async function fetchWeather() {
      try {
        const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${PURWOKERTO_LAT}&lon=${PURWOKERTO_LON}&appid=${API_KEY}&units=metric&lang=id`);
        if (!response.ok) throw new Error('Gagal mengambil data cuaca');
        const data = await response.json();
        updateWeatherUI(data);
      } catch (error) {
        console.error('Error fetching weather:', error);
        document.getElementById('weatherIcon').className = 'fas fa-exclamation-triangle weather-icon';
        document.getElementById('weatherTemp').textContent = 'Error';
      }
    }

    function updateWeatherUI(data) {
      const weather = data.weather[0];
      const main = data.main;
      const wind = data.wind;
      const iconClass = weatherIcons[weather.icon] || 'fas fa-cloud';
      document.getElementById('weatherIcon').className = iconClass + ' weather-icon';
      document.getElementById('weatherTemp').textContent = `${Math.round(main.temp)}°C`;
      document.getElementById('weatherDetailsIcon').className = iconClass + ' weather-details-icon';
      document.getElementById('weatherDetailsTemp').textContent = `${Math.round(main.temp)}°C`;
      document.getElementById('weatherDetailsDesc').textContent = weather.description;
      document.getElementById('weatherMinTemp').textContent = `${Math.round(main.temp_min)}°C`;
      document.getElementById('weatherMaxTemp').textContent = `${Math.round(main.temp_max)}°C`;
      document.getElementById('weatherHumidity').textContent = main.humidity;
      document.getElementById('weatherWind').textContent = wind.speed;
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('weatherDate').textContent = new Date().toLocaleDateString('id-ID', options);
    }

    function toggleWeatherDetails() {
      document.getElementById('weatherDetails').classList.toggle('show');
    }

    function renderMap() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      kulinerData.forEach((item, index) => {
        const icon = item.keliling ? '🛺' : '🏠';
        const marker = L.marker([item.lat, item.lng], {
          icon: L.divIcon({ html: `<div style="font-size:20px;">${icon}</div>`, className: 'marker-icon', iconSize: [30, 30] })
        }).addTo(map).bindPopup(`<b>${item.nama}</b><br>${item.kategori}`).on('click', () => showDetail(index));
        markers.push(marker);
      });
    }

    function renderList(search = "", category = "") {
      const list = document.getElementById("list");
      list.innerHTML = "";
      const filteredData = kulinerData.filter(d =>
        d.nama.toLowerCase().includes(search.toLowerCase()) &&
        (category === "" || d.kategori === category)
      );
      if (filteredData.length === 0) {
        list.innerHTML = "<p style='text-align:center;'>Tidak ada hasil ditemukan</p>";
        return;
      }
      filteredData.forEach((d, i) => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `<h3>${d.nama}</h3><p>${d.kategori}</p><small>${d.alamat}</small><small>• ${d.jam} • ${d.harga}</small>`;
        div.onclick = () => showDetail(i);
        list.appendChild(div);
      });
    }

    function showDetail(index) {
      const item = kulinerData[index];
      document.getElementById("detailContent").innerHTML = `
        <h3>${item.nama}</h3>
        <p><strong>Kategori:</strong> ${item.kategori}</p>
        <p><strong>Alamat:</strong> ${item.alamat}</p>
        <p><strong>Jam:</strong> ${item.jam}</p>
        <p><strong>Harga:</strong> ${item.harga}</p>
        <p><strong>Deskripsi:</strong> ${item.deskripsi}</p>
        <p><strong>Parkir:</strong> ${item.parkir}</p>
        <p><strong>Rute:</strong> ${item.rute}</p>
        <img src="${item.foto}" alt="${item.nama}">
      `;
      document.getElementById("detailPopup").style.display = "block";
      map.setView([item.lat, item.lng], 15);
    }

    function closeDetail() {
      document.getElementById("detailPopup").style.display = "none";
    }

    function toggleChat() {
      const chat = document.getElementById("chatPopup");
      chat.style.display = chat.style.display === "flex" ? "none" : "flex";
      document.getElementById("chatInput").focus();
    }

    function scrollChatToBottom() {
      const chatMessages = document.getElementById("chatMessages");
      if (chatMessages) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    }

    async function sendChat() {
      const input = document.getElementById("chatInput").value.trim();
      const chatMessages = document.getElementById("chatMessages");

      if (!input) return;

      const now = new Date();
      const timeString = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

      chatMessages.innerHTML += `
        <div class="message message-user">
          ${input}
          <div class="message-time">${timeString}</div>
        </div>
      `;
      document.getElementById("chatInput").value = "";
      scrollChatToBottom();

      const typingIndicator = document.createElement('div');
      typingIndicator.className = 'message message-bot typing-indicator';
      typingIndicator.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
      chatMessages.appendChild(typingIndicator);
      scrollChatToBottom();

      try {
        const reply = await getAIResponse(input);
        chatMessages.removeChild(typingIndicator);
        chatMessages.innerHTML += `
          <div class="message message-bot">
            ${reply}
            <div class="message-time">${timeString}</div>
          </div>
        `;
        scrollChatToBottom();
      } catch (error) {
        chatMessages.removeChild(typingIndicator);
        chatMessages.innerHTML += `
          <div class="message message-bot">
            ${fallbackResponse(input)}
            <div class="message-time">${timeString}</div>
          </div>
        `;
        scrollChatToBottom();
      }
    }

    async function getAIResponse(userInput) {
      const API_KEY = 'AIzaSyCF5hhmx5wLMc1FAFLgnDmyUQl1QOg25S4';
      const weatherTemp = document.getElementById('weatherTemp')?.textContent || '25°C';
      const weatherDesc = document.getElementById('weatherDetailsDesc')?.textContent || 'Cerah';

      const context = `
# IDENTITAS & TUJUAN UTAMA
Anda adalah MakanBot, asisten AI kuliner yang sangat ramah dan berpengetahuan luas tentang makanan khas Purwokerto. Gaya bahasa Anda santai, informatif, dan selalu membantu. Anda harus selalu menggunakan informasi dari basis data di bawah ini untuk menjawab pertanyaan.

# KONTEKS SAAT INI
- Lokasi: Purwokerto
- Cuaca: ${weatherDesc}, suhu ${weatherTemp}

# BASIS DATA KULINER PURWOKERTO
[
  {
    "Nama": "Soto Sokaraja",
    "Alias": "sroto",
    "Deskripsi": "Soto khas dengan kuah kaldu sapi bening yang dicampur dengan sambal kacang, disajikan dengan ketupat, tauge, dan kerupuk.",
    "Harga": "Rp 12.000 - Rp 20.000",
    "Lokasi": "Pusat Soto di Jl. Sokaraja",
    "Jam Buka": "07:00 - 15:00"
  },
  {
    "Nama": "Tempe Mendoan",
    "Alias": "mendo",
    "Deskripsi": "Tempe lembaran tipis yang digoreng dengan adonan tepung setengah matang (lembek), disajikan dengan cabai rawit atau sambal kecap.",
    "Harga": "Rp 2.000 - Rp 5.000",
    "Lokasi": "Banyak dijual di pinggir jalan, pusatnya di area Pasar Sokaraja",
    "Jam Buka": "Pagi - Malam"
  },
  {
    "Nama": "Getuk Goreng",
    "Alias": "getuk",
    "Deskripsi": "Jajanan dari singkong yang dihaluskan, diisi gula aren, lalu digoreng hingga bagian luarnya renyah.",
    "Harga": "Rp 5.000 - Rp 10.000 per bungkus",
    "Lokasi": "Pusat oleh-oleh di Jl. Jend. Sudirman",
    "Jam Buka": "08:00 - 21:00"
  },
  {
    "Nama": "Tahu Brontak",
    "Alias": "brontak",
    "Deskripsi": "Tahu goreng dengan isian sayuran (tauge, wortel) yang melimpah hingga 'memberontak' keluar dari tahu.",
    "Harga": "Rp 3.000 - Rp 6.000",
    "Lokasi": "Pasar Sokaraja dan pasar tradisional lainnya",
    "Jam Buka": "Pagi - Sore"
  },
  {
    "Nama": "Kraca",
    "Alias": "keong sawah",
    "Deskripsi": "Keong sawah yang dimasak dengan bumbu pedas kaya rempah. Cara makannya disedot langsung dari cangkangnya.",
    "Harga": "Rp 8.000 - Rp 12.000 per porsi",
    "Lokasi": "Biasanya dijual malam hari di area Pasar Malam atau alun-alun",
    "Jam Buka": "18:00 - 23:00"
  },
  {
    "Nama": "Empal Basah",
    "Alias": "empal",
    "Deskripsi": "Potongan daging sapi empuk yang dimasak dengan kuah santan kental berbumbu rempah. Rasanya gurih dan sedikit manis.",
    "Harga": "Rp 15.000 - Rp 25.000",
    "Lokasi": "Warung makan di sekitar Jl. HR Bunyamin",
    "Jam Buka": "10:00 - 20:00"
  },
  {
    "Nama": "Dawet Ayu",
    "Alias": "dawet",
    "Deskripsi": "Minuman segar berisi cendol hijau, santan, dan gula jawa cair. Disajikan dingin dengan es.",
    "Harga": "Rp 5.000 - Rp 8.000",
    "Lokasi": "Banyak ditemukan di area Pasar Wage",
    "Jam Buka": "09:00 - 16:00"
  }
]

# KAMUS ISTILAH LOKAL
- sroto: Soto Sokaraja
- mendo: Tempe Mendoan
- getuk: Getuk Goreng
- kraca: Kraca (Keong Sawah)
- dawet: Dawet Ayu
- brontak: Tahu Brontak
- empal: Empal Basah

# ATURAN PERILAKU
1.  Selalu sapa pengguna dengan ramah.
2.  Gunakan informasi dari KONTEKS CUACA untuk memberi rekomendasi yang relevan.
3.  Jika cuaca panas, prioritaskan rekomendasi Es Dawet Ayu atau jajanan seperti Getuk Goreng.
4.  Jika cuaca hujan atau dingin, prioritaskan rekomendasi makanan hangat seperti Soto Sokaraja.
5.  Jika pengguna bertanya pada malam hari atau mencari makan malam, prioritaskan rekomendasi Kraca atau Tempe Mendoan.
6.  Jika pengguna mencari makanan yang murah, prioritaskan rekomendasi Tempe Mendoan atau Tahu Brontak.
7.  Jika pengguna bertanya untuk oleh-oleh atau sambil jalan-jalan, rekomendasikan Getuk Goreng atau Tempe Mendoan.
8.  Selalu berikan detail singkat (deskripsi, harga, lokasi) dari basis data saat merekomendasikan.

# CONTOH INTERAKSI

Pengguna: "sroto sing enak nang ndi?"
MakanBot: "Halo! Kalau cari Sroto (Soto Sokaraja) yang mantap, pusatnya ada di sepanjang Jl. Sokaraja. Soto di sana khas banget karena pakai sambal kacang. Harganya sekitar Rp 12.000 sampai Rp 20.000. Biasanya buka dari pagi sampai sore."

Pengguna: "Purwokerto lagi panas banget, enaknya jajan apa ya?"
MakanBot: "Wah, pas banget cuacanya lagi panas gini! Biar seger, coba deh Es Dawet Ayu di daerah Pasar Wage. Cendolnya kenyal, terus dipadu santan sama gula jawa, cuma sekitar Rp 5.000-an aja. Pasti langsung adem!"

Pengguna: "rekomendasi makan malem dong"
MakanBot: "Malam-malam di Purwokerto paling asyik nyari Kraca, mas/mbak! Itu lho, keong sawah yang dimasak pedas. Biasanya banyak yang jual di area Pasar Malam. Harganya murah meriah, sekitar Rp 8.000 - Rp 12.000 seporsi. Berani coba?"

Pengguna: "makanan murah dong"
MakanBot: "Coba Tempe Mendoan cuma Rp 2.000–5.000, atau Tahu Brontak Rp 3.000–6.000. Hemat dan enak!"

# TUGAS SAAT INI
Jawab pertanyaan pengguna berdasarkan semua informasi dan aturan di atas.

Pengguna: "${userInput}"
MakanBot:
      `;

      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: context }] }],
            generationConfig: { temperature: 0.7, topK: 40, topP: 0.95, maxOutputTokens: 800 }
          })
        });
        const data = await response.json();
        return data?.candidates?.[0]?.content?.parts?.[0]?.text || fallbackResponse(userInput);
      } catch (error) {
        console.error("AI API Error:", error);
        return fallbackResponse(userInput);
      }
    }

    function fallbackResponse(input) {
      const lower = input.toLowerCase();
      if (lower.includes("rekomendasi") || lower.includes("apa enak")) {
        const r = kulinerData[Math.floor(Math.random() * kulinerData.length)];
        return `Saya merekomendasikan <b>${r.nama}</b> (${r.kategori}) di ${r.alamat}. Buka jam ${r.jam}, harga ${r.harga}.`;
      }
      if (lower.includes("soto") || lower.includes("sroto")) return "Soto Sokaraja di Jl. Sokaraja, kuah kacang khas Banyumas, buka 07:00–15:00.";
      if (lower.includes("mendo") || lower.includes("tempe goreng")) return "Tempe Mendoan di Pasar Sokaraja, goreng setengah matang, hanya Rp 2.000–5.000.";
      if (lower.includes("getuk")) return "Getuk Goreng di Jl. Sudirman, singkong goreng isi gula aren, harga Rp 5.000–10.000.";
      if (lower.includes("kraca") || lower.includes("keong")) return "Kraca dijual malam di Pasar Malam Purwokerto, keong sawah masak pedas, Rp 8.000–12.000.";
      if (lower.includes("brontak") || lower.includes("tahu isi")) return "Tahu Brontak di Pasar Sokaraja, tahu isi sayur keluar saat digoreng, Rp 3.000–6.000.";
      if (lower.includes("dawet") || lower.includes("es dawet")) return "Dawet Ayu di Pasar Wage, minuman segar cendol santan gula jawa, Rp 5.000–8.000.";
      if (lower.includes("empal")) return "Empal Basah di Warung Bu Yati, daging sapi kuah santan pedas, cocok dengan ketupat janur.";
      if (lower.includes("murah")) return "Coba Tempe Mendoan (Rp 2.000–5.000), Tahu Brontak (Rp 3.000–6.000), atau Nopia (Rp 3.000–6.000).";
      if (lower.includes("malam")) return "Kraca dijual malam di Pasar Malam Purwokerto, cocok untuk jajan malam!";
      if (lower.includes("hai") || lower.includes("hello")) return "Halo! Mau cari kuliner apa di Purwokerto hari ini?";
      return "Maaf, aku belum paham. Coba tanya: 'Makanan murah apa?' atau 'Rekomendasi untuk cuaca hujan?'";
    }

    document.addEventListener('DOMContentLoaded', () => {
      renderMap();
      renderList();
      fetchWeather();
      setInterval(fetchWeather, 30 * 60 * 1000);
      document.getElementById("search").addEventListener("input", (e) => {
        renderList(e.target.value, document.getElementById("filter").value);
      });
      document.getElementById("filter").addEventListener("change", (e) => {
        renderList(document.getElementById("search").value, e.target.value);
      });
    });
  </script>
</body>
</html>
