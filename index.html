<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Lapor Mangan! - Purwokerto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --red: #c53e4e;
      --light-red: #d8c2cf;
      --bg: #f8f9fa;
      --white: #ffffff;
      --text: #333;
      --blue: #2980b9;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; }
    body { background: var(--bg); color: var(--text); }
    header {
      background: var(--red);
      color: var(--white);
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      position: relative;
      flex-wrap: wrap;
    }
    .header-content {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
      min-width: 200px;
    }
    header img { height: 40px; }
    .weather-info {
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 12px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
      white-space: nowrap;
    }
    .weather-info:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    .weather-icon {
      font-size: 20px;
    }
    .weather-temp {
      font-weight: 600;
      font-size: 16px;
    }
    .weather-details {
      position: absolute;
      top: 100%;
      right: 20px;
      background: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      z-index: 1000;
      width: 250px;
      display: none;
      color: var(--text);
    }
    .weather-details.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    #map {
      height: 60vh;
      width: 100%;
    }
    .container {
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }
    .filter-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .filter-bar input,
    .filter-bar select,
    .filter-bar button {
      flex: 1;
      padding: 10px;
      border: 1px solid var(--light-red);
      border-radius: 8px;
      min-width: 120px;
    }
    .filter-bar button {
      background: var(--red);
      color: white;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .filter-bar button:hover {
      background: #b03545;
    }
    .card {
      background: var(--white);
      border-left: 5px solid var(--red);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .card:hover { transform: translateY(-3px); }
    .card h3 { color: var(--red); }
    .card small { color: #666; }
    .detail-popup {
      display: none;
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      z-index: 9999;
      max-width: 400px;
      width: 90%;
    }
    .detail-popup img {
      width: 100%;
      border-radius: 8px;
      margin-top: 10px;
    }
    .close-btn {
      float: right;
      cursor: pointer;
      font-size: 20px;
      color: var(--red);
    }
    /* Tombol Tambah Kuliner */
    .filter-bar .add-btn {
      background: #27ae60;
      color: white;
      min-width: 120px;
    }
    
    /* ---------- STYLES UNTUK RAG CHATBOT ---------- */
    /* Variabel warna dan style untuk chatbot, terinspirasi dari desain modern */
    :root {
      --rag-bg: #f5f5f5; /* Warna latar belakang utama chat */
      --rag-surface: #fffffe; /* Warna permukaan untuk bubble chat bot */
      --rag-txt: #243746; /* Warna teks utama */
      --rag-accent: #0077b6; /* Warna aksen untuk bubble chat user dan tombol */
      --rag-radius: 12px; /* Radius sudut untuk elemen UI */
      --rag-shadow: 0 2px 6px rgba(0,0,0,.1); /* Bayangan untuk memberi kedalaman */
    }

    /* Tombol untuk membuka chatbot */
    .chatbot-toggler {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--rag-accent);
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      z-index: 999;
      box-shadow: var(--rag-shadow);
      transition: transform 0.3s ease;
    }
    .chatbot-toggler:hover {
      transform: scale(1.1);
    }

    /* Kontainer popup chat */
    .rag-chat-popup {
      display: none; /* Awalnya disembunyikan */
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 350px;
      height: 500px;
      background: var(--rag-bg);
      border-radius: var(--rag-radius);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      z-index: 1000;
    }

    /* Header dari popup chat */
    .rag-chat-header {
      padding: 1rem;
      background: var(--rag-accent);
      color: #fff;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .rag-chat-close {
      cursor: pointer;
      font-size: 20px;
    }

    /* Area untuk menampilkan pesan-pesan chat */
    #rag-chat-messages {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: .75rem;
    }

    /* Styling umum untuk setiap bubble pesan */
    .rag-msg {
      max-width: 80%;
      padding: .75rem 1rem;
      border-radius: var(--rag-radius);
      box-shadow: var(--rag-shadow);
      line-height: 1.4;
    }

    /* Bubble pesan dari pengguna */
    .rag-user {
      align-self: flex-end;
      background: var(--rag-accent);
      color: #fff;
      border-bottom-right-radius: 4px;
    }

    /* Bubble pesan dari bot */
    .rag-bot {
      align-self: flex-start;
      background: var(--rag-surface);
      color: var(--rag-txt);
      border-bottom-left-radius: 4px;
    }

    /* Form input untuk mengirim pesan */
    #rag-chat-form {
      display: flex;
      gap: .5rem;
      padding: 1rem;
      border-top: 1px solid #ddd;
      background: #fff;
    }

    /* Input field dan tombol */
    #rag-chat-form input, #rag-chat-form button {
      font: inherit;
      padding: .65rem 1rem;
      border-radius: var(--rag-radius);
      border: 1px solid #ccd;
      outline: none;
    }
    #rag-chat-form input {
      flex: 1;
    }
    #rag-chat-form button {
      background: var(--rag-accent);
      color: #fff;
      border: none;
      cursor: pointer;
    }
    /* Modal Google Form */
    .modal-iframe {
      width: 90%;
      max-width: 800px;
      height: 80vh;
      margin: 5% auto;
      background: white;
      border-radius: 15px;
      overflow: hidden;
    }
    .modal-iframe-content {
      width: 100%;
      height: 100%;
      border: none;
    }
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    /* Responsive */
    @media (max-width: 768px) {
      .filter-bar {
        flex-direction: column;
      }
      .filter-bar input,
      .filter-bar select,
      .filter-bar button {
        width: 100%;
      }
      .chat-popup {
        width: calc(100% - 40px);
        right: 20px;
        left: 20px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1>Lapor Mangan! - Purwokerto</h1>
    </div>
    <div class="weather-info" id="weatherInfo" onclick="toggleWeatherDetails()">
      <i class="fas fa-cloud-sun weather-icon" id="weatherIcon"></i>
      <span class="weather-temp" id="weatherTemp">--°C</span>
    </div>
    <div class="weather-details" id="weatherDetails">
      <div class="weather-details-header">
        <h3>Cuaca Purwokerto</h3>
        <small id="weatherDate">Hari ini</small>
      </div>
      <div class="weather-details-main">
        <i class="fas fa-cloud-sun weather-details-icon" id="weatherDetailsIcon"></i>
        <div>
          <div class="weather-details-temp" id="weatherDetailsTemp">--°C</div>
          <div class="weather-details-desc" id="weatherDetailsDesc">--</div>
        </div>
      </div>
      <div class="weather-details-stats">
        <div class="weather-stat">
          <i class="fas fa-temperature-low"></i>
          <span>Min: <span id="weatherMinTemp">--°C</span></span>
        </div>
        <div class="weather-stat">
          <i class="fas fa-temperature-high"></i>
          <span>Max: <span id="weatherMaxTemp">--°C</span></span>
        </div>
        <div class="weather-stat">
          <i class="fas fa-tint"></i>
          <span>Kelembapan: <span id="weatherHumidity">--%</span></span>
        </div>
        <div class="weather-stat">
          <i class="fas fa-wind"></i>
          <span>Angin: <span id="weatherWind">-- m/s</span></span>
        </div>
      </div>
    </div>
  </header>
  <div id="map"></div>
  <div class="container">
    <div class="filter-bar">
      <input id="search" placeholder="Cari nama kuliner..." />
      <select id="filter">
        <option value="">Semua</option>
        <option value="Soto">Soto</option>
        <option value="Gorengan">Gorengan</option>
        <option value="Jajanan Tradisional">Jajanan Tradisional</option>
        <option value="Camilan Kering">Camilan Kering</option>
        <option value="Kue Tradisional">Kue Tradisional</option>
        <option value="Kuliner Unik">Kuliner Unik</option>
        <option value="Sayuran">Sayuran</option>
        <option value="Dodol">Dodol</option>
        <option value="Kue Kering">Kue Kering</option>
        <option value="Makanan Ringan">Makanan Ringan</option>
        <option value="Camilan">Camilan</option>
        <option value="Camilan Manis">Camilan Manis</option>
        <option value="Minuman">Minuman</option>
        <option value="Sate">Sate</option>
        <option value="Bakso">Bakso</option>
        <option value="Mie">Mie</option>
        <option value="Makanan Berat">Makanan Berat</option>
        <option value="Nasi Goreng">Nasi Goreng</option>
      </select>
      <button onclick="showWeatherRec()">Rekomendasi Cuaca</button>
      <button onclick="openGoogleForm()">📋 Tambah Informasi</button>
    </div>
    <div id="list"></div>
  </div>
  <!-- Detail Popup -->
  <div class="detail-popup" id="detailPopup">
    <span class="close-btn" onclick="closeDetail()">×</span>
    <div id="detailContent"></div>
  </div>
  <!-- Modal Google Form -->
  <div id="googleFormModal" class="modal">
    <div class="modal-iframe">
      <span class="close-btn" onclick="closeGoogleForm()" style="position: absolute; right: 15px; top: 15px; z-index: 10001;">&times;</span>
      <iframe src="https://docs.google.com/forms/d/e/1FAIpQLScJ8tkZau-NVdhbmd0cWFKY25VBm0Ajjxvqo-rLYAO_iGb2qg/viewform?embedded=true" class="modal-iframe-content"></iframe>
    </div>
  </div>

  <!-- ---------- RAG CHATBOT INTERFACE ---------- -->
  <!-- Tombol bulat untuk membuka/menutup popup chat -->
  <div class="chatbot-toggler" onclick="toggleRagChat()">
    <span>🤖</span>
  </div>

  <!-- Popup chat yang berisi seluruh antarmuka chatbot -->
  <div class="rag-chat-popup" id="ragChatPopup">
    <!-- Header popup chat -->
    <div class="rag-chat-header">
      <span>LaporMangan AI Assistant</span>
      <span class="rag-chat-close" onclick="toggleRagChat()">×</span>
    </div>
    
    <!-- Kontainer untuk semua pesan (dari user dan bot) -->
    <main id="rag-chat-messages"></main>
    
    <!-- Form untuk mengetik dan mengirim pesan -->
    <form id="rag-chat-form">
      <input id="rag-q" autocomplete="off" placeholder="Tanya seputar kuliner..." required />
      <button>Kirim</button>
    </form>
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Data kuliner dari file markdown
    const kulinerData = [
      // Soto
      {
        nama: "Soto Sokaraja",
        kategori: "Soto",
        alamat: "Jl. Sokaraja",
        jam: "07:00 - 15:00",
        harga: "Rp 12.000 - 20.000",
        deskripsi: "Kuah kaldu sapi + kacang, ketupat, kerupuk",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tersedia",
        rute: "Area Sokaraja",
        lat: -7.4220,
        lng: 109.2300,
        keliling: false
      },
      {
        nama: "Soto Tauco",
        kategori: "Soto",
        alamat: "Jl. Gerilya",
        jam: "08:00 - 16:00",
        harga: "Rp 15.000 - 25.000",
        deskripsi: "Kuah tauco khas, tauge, ayam suwir",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. Gerilya",
        lat: -7.4210,
        lng: 109.2400,
        keliling: false
      },
      {
        nama: "Soto Kecik",
        kategori: "Soto",
        alamat: "Jl. Kecik",
        jam: "07:00 - 14:00",
        harga: "Rp 12.000 - 18:000",
        deskripsi: "Kuah bening, ayam kampung",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Jl. Kecik",
        lat: -7.4230,
        lng: 109.2350,
        keliling: false
      },
      {
        nama: "Soto Dower",
        kategori: "Soto",
        alamat: "Jl. Dower",
        jam: "08:00 - 16:00",
        harga: "Rp 13.000 - 20.000",
        deskripsi: "Kuah santan, bumbu rempah khas",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Jl. Dower",
        lat: -7.4240,
        lng: 109.2320,
        keliling: false
      },
      {
        nama: "Soto Petirtaan",
        kategori: "Soto",
        alamat: "Jl. Petirtaan",
        jam: "07:00 - 14:00",
        harga: "Rp 12.000 - 18.000",
        deskripsi: "Kuah bening, ayam kampung",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Jl. Petirtaan",
        lat: -7.4250,
        lng: 109.2380,
        keliling: false
      },
      {
        nama: "Soto Bening",
        kategori: "Soto",
        alamat: "Jl. Merdeka",
        jam: "07:00 - 14:00",
        harga: "Rp 12.000 - 18.000",
        deskripsi: "Kuah bening, ayam kampung",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. Merdeka",
        lat: -7.4200,
        lng: 109.2450,
        keliling: false
      },
      // Gorengan
      {
        nama: "Tempe Mendoan",
        kategori: "Gorengan",
        alamat: "Pasar Sokaraja",
        jam: "06:00 - 18:00",
        harga: "Rp 2.000 - 5.000",
        deskripsi: "Digoreng setengah matang",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tersedia",
        rute: "Pasar Sokaraja",
        lat: -7.4200,
        lng: 109.2300,
        keliling: true
      },
      {
        nama: "Tahu Brontak",
        kategori: "Gorengan",
        alamat: "Pasar Sokaraja",
        jam: "08:00 - 17:00",
        harga: "Rp 3.000 - 6.000",
        deskripsi: "Tahu isi sayuran",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Pasar Sokaraja",
        lat: -7.4205,
        lng: 109.2305,
        keliling: true
      },
      {
        nama: "Tahu Gimbal",
        kategori: "Gorengan",
        alamat: "Alun-Alun Purwokerto",
        jam: "15:00 - 22:00",
        harga: "Rp 10.000 - 15.000",
        deskripsi: "Tahu + udang goreng, bumbu kacang",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Alun-Alun",
        lat: -7.4100,
        lng: 109.2400,
        keliling: true
      },
      {
        nama: "Tahu Gejrot",
        kategori: "Gorengan",
        alamat: "Jl. Kolonel Sugiono",
        jam: "15:00 - 22:00",
        harga: "Rp 8.000 - 12.000",
        deskripsi: "Tahu goreng kuah asam pedas",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Jl. Kolonel Sugiono",
        lat: -7.4150,
        lng: 109.2420,
        keliling: true
      },
      // Jajanan Tradisional
      {
        nama: "Getuk Goreng",
        kategori: "Jajanan Tradisional",
        alamat: "Jl. Sudirman",
        jam: "08:00 - 17:00",
        harga: "Rp 5.000 - 10.000",
        deskripsi: "Singkong isi gula aren",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. Sudirman - Alun-Alun",
        lat: -7.4100,
        lng: 109.2450,
        keliling: true
      },
      {
        nama: "Cenil",
        kategori: "Jajanan Tradisional",
        alamat: "Jl. Dr. Soeparno",
        jam: "08:00 - 16:00",
        harga: "Rp 3.000 - 5.000",
        deskripsi: "Singkong berwarna-warni",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Sekitar kampus UNSOED",
        lat: -7.4050,
        lng: 109.2500,
        keliling: true
      },
      {
        nama: "Gethuk Lindri",
        kategori: "Jajanan Tradisional",
        alamat: "Jl. S. Parman",
        jam: "08:00 - 17:00",
        harga: "Rp 7.000 - 12.000",
        deskripsi: "Getuk berwarna-warni",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Jl. S. Parman - Pasar Wage",
        lat: -7.4120,
        lng: 109.2480,
        keliling: true
      },
      {
        nama: "Klepon",
        kategori: "Jajanan Tradisional",
        alamat: "Pasar Kliwon",
        jam: "08:00 - 16:00",
        harga: "Rp 2.000 - 3.000",
        deskripsi: "Bola ketan isi gula merah",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Pasar Kliwon",
        lat: -7.4180,
        lng: 109.2430,
        keliling: true
      },
      {
        nama: "Onde-onde",
        kategori: "Jajanan Tradisional",
        alamat: "Jl. Pramuka",
        jam: "08:00 - 17:00",
        harga: "Rp 2.000 - 3.000",
        deskripsi: "Bola tepung ketan isi kacang",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Jl. Pramuka",
        lat: -7.4160,
        lng: 109.2460,
        keliling: true
      },
      {
        nama: "Lupis",
        kategori: "Jajanan Tradisional",
        alamat: "Pasar Pon",
        jam: "07:00 - 14:00",
        harga: "Rp 3.000 - 5.000",
        deskripsi: "Ketan bungkus daun",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Pasar Pon",
        lat: -7.4190,
        lng: 109.2410,
        keliling: true
      },
      {
        nama: "Gethuk",
        kategori: "Jajanan Tradisional",
        alamat: "Jl. Sumpah Pemuda",
        jam: "08:00 - 16:00",
        harga: "Rp 5.000 - 8.000",
        deskripsi: "Singkong halus + gula merah",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Jl. Sumpah Pemuda",
        lat: -7.4140,
        lng: 109.2440,
        keliling: true
      },
      {
        nama: "Lemper",
        kategori: "Jajanan Tradisional",
        alamat: "Pasar Wage",
        jam: "08:00 - 16:00",
        harga: "Rp 3.000 - 5.000",
        deskripsi: "Ketupat isi abon ayam",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Pasar Wage",
        lat: -7.4170,
        lng: 109.2420,
        keliling: true
      },
      // Camilan Kering
      {
        nama: "Klanting",
        kategori: "Camilan Kering",
        alamat: "Pasar Baru",
        jam: "09:00 - 17:00",
        harga: "Rp 5.000 - 10.000",
        deskripsi: "Cemilan singkong berbentuk anting",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Pasar Baru - Terminal",
        lat: -7.4200,
        lng: 109.2380,
        keliling: true
      },
      {
        nama: "Lanting",
        kategori: "Camilan Kering",
        alamat: "Pasar Kliwon",
        jam: "08:00 - 16:00",
        harga: "Rp 10.000 - 15.000",
        deskripsi: "Ketan bulat kecil renyah",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Pasar Kliwon - Alun-Alun",
        lat: -7.4180,
        lng: 109.2430,
        keliling: true
      },
      {
        nama: "Intip",
        kategori: "Camilan Kering",
        alamat: "Pasar Pon",
        jam: "07:00 - 14:00",
        harga: "Rp 5.000 - 10.000",
        deskripsi: "Kerak nasi kering digoreng",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Pasar Pon",
        lat: -7.4190,
        lng: 109.2410,
        keliling: true
      },
      {
        nama: "Dage",
        kategori: "Camilan Kering",
        alamat: "Jl. Sudirman",
        jam: "09:00 - 16:00",
        harga: "Rp 5.000 - 8.000",
        deskripsi: "Ampas kacang + cabe rawit",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. Sudirman",
        lat: -7.4100,
        lng: 109.2450,
        keliling: true
      },
      // Kue Tradisional
      {
        nama: "Nopia",
        kategori: "Kue Tradisional",
        alamat: "Jl. Sudirman",
        jam: "07:00 - 18:00",
        harga: "Rp 3.000 - 6.000",
        deskripsi: "Isi gula merah/kacang/cokelat",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. Sudirman - Pasar Wage",
        lat: -7.4100,
        lng: 109.2450,
        keliling: true
      },
      {
        nama: "Serabi Notosuman",
        kategori: "Kue Tradisional",
        alamat: "Jl. Notosuman",
        jam: "14:00 - 20:00",
        harga: "Rp 5.000 - 8.000",
        deskripsi: "Topping gula merah + santan",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Jl. Notosuman",
        lat: -7.4110,
        lng: 109.2460,
        keliling: false
      },
      {
        nama: "Nagasari",
        kategori: "Kue Tradisional",
        alamat: "Jl. Dr. Cipto",
        jam: "08:00 - 16:00",
        harga: "Rp 2.000 - 3.000",
        deskripsi: "Tepung beras + pisang",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Jl. Dr. Cipto",
        lat: -7.4080,
        lng: 109.2480,
        keliling: true
      },
      // Kuliner Unik
      {
        nama: "Kraca",
        kategori: "Kuliner Unik",
        alamat: "Pasar Malam Purwokerto",
        jam: "18:00 - 23:00",
        harga: "Rp 8.000 - 12.000",
        deskripsi: "Keong kecil masak pedas",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Pasar Malam - Alun-Alun",
        lat: -7.4100,
        lng: 109.2400,
        keliling: true
      },
      // Sayuran
      {
        nama: "Kuluban / Kluban",
        kategori: "Sayuran",
        alamat: "Jl. HR Bunyamin",
        jam: "10:00 - 15:00",
        harga: "Rp 8.000 - 12.000",
        deskripsi: "Sayuran rebus + sambal kelapa",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. HR Bunyamin - Pasar Kliwon",
        lat: -7.4090,
        lng: 109.2420,
        keliling: false
      },
      // Dodol
      {
        nama: "Jenang Jaket",
        kategori: "Dodol",
        alamat: "Pasar Wage",
        jam: "08:00 - 16:00",
        harga: "Rp 5.000 - 10.000",
        deskripsi: "Tepung ketan + santan + gula merah",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Pasar Wage - Terminal",
        lat: -7.4170,
        lng: 109.2420,
        keliling: true
      },
      // Kue Kering
      {
        nama: "Jalabiya",
        kategori: "Kue Kering",
        alamat: "Jl. Pramuka",
        jam: "09:00 - 17:00",
        harga: "Rp 4.000 - 7.000",
        deskripsi: "Singkong isi gula merah",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Jl. Pramuka - Pasar Baru",
        lat: -7.4160,
        lng: 109.2460,
        keliling: true
      },
      // Makanan Ringan
      {
        nama: "Sahoun",
        kategori: "Makanan Ringan",
        alamat: "Jl. Gatot Subroto",
        jam: "10:00 - 16:00",
        harga: "Rp 8.000 - 12.000",
        deskripsi: "Soun berkuah ayam",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. Gatot Subroto - Kampus UNSOED",
        lat: -7.4070,
        lng: 109.2490,
        keliling: false
      },
      {
        nama: "Lumpia Boom",
        kategori: "Makanan Ringan",
        alamat: "Jl. Sudirman",
        jam: "09:00 - 18:00",
        harga: "Rp 10.000 - 15.000",
        deskripsi: "Lumpia besar isi sayur/telur/ayam",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. Sudirman - Pasar Wage",
        lat: -7.4100,
        lng: 109.2450,
        keliling: true
      },
      // Camilan
      {
        nama: "Combro",
        kategori: "Camilan",
        alamat: "Jl. HR Bunyamin",
        jam: "07:00 - 18:00",
        harga: "Rp 3.000 - 5.000",
        deskripsi: "Singkong isi oncom pedas",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. HR Bunyamin - Alun-Alun",
        lat: -7.4090,
        lng: 109.2420,
        keliling: true
      },
      {
        nama: "Cimplung",
        kategori: "Camilan",
        alamat: "Jl. Pramuka",
        jam: "08:00 - 16:00",
        harga: "Rp 3.000 - 5.000",
        deskripsi: "Singkong + kelapa + gula aren",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Jl. Pramuka - Terminal",
        lat: -7.4160,
        lng: 109.2460,
        keliling: true
      },
      // Camilan Manis
      {
        nama: "Wajik Kletik",
        kategori: "Camilan Manis",
        alamat: "Jl. Dr. Cipto",
        jam: "08:00 - 17:00",
        harga: "Rp 3.000 - 6.000",
        deskripsi: "Wajik kenyal dari gula jawa",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Jl. Dr. Cipto - Pasar Kliwon",
        lat: -7.4080,
        lng: 109.2480,
        keliling: true
      },
      // Minuman
      {
        nama: "Dawet Ayu",
        kategori: "Minuman",
        alamat: "Pasar Wage",
        jam: "08:00 - 17:00",
        harga: "Rp 5.000 - 8.000",
        deskripsi: "Cendol, santan, gula jawa",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Pasar Wage",
        lat: -7.4170,
        lng: 109.2420,
        keliling: true
      },
      {
        nama: "Es Gempol",
        kategori: "Minuman",
        alamat: "Pasar Wage",
        jam: "10:00 - 18:00",
        harga: "Rp 7.000 - 10.000",
        deskripsi: "Gempol, santan, gula merah",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Pasar Wage",
        lat: -7.4170,
        lng: 109.2420,
        keliling: true
      },
      {
        nama: "Es Cendol Dawet",
        kategori: "Minuman",
        alamat: "Jl. Dr. Soeparno",
        jam: "10:00 - 18:00",
        harga: "Rp 5.000 - 8.000",
        deskripsi: "Tepung beras, santan, gula merah",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Jl. Dr. Soeparno",
        lat: -7.4050,
        lng: 109.2500,
        keliling: true
      },
      {
        nama: "Wedang Ronde",
        kategori: "Minuman",
        alamat: "Pasar Malam Purwokerto",
        jam: "18:00 - 23:00",
        harga: "Rp 8.000 - 12.000",
        deskripsi: "Bola ketan, jahe, kacang",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Pasar Malam Purwokerto",
        lat: -7.4100,
        lng: 109.2400,
        keliling: true
      },
      {
        nama: "Es Puter",
        kategori: "Minuman",
        alamat: "Jl. Sudirman",
        jam: "10:00 - 18:00",
        harga: "Rp 5.000 - 10.000",
        deskripsi: "Es krim tradisional",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Jl. Sudirman",
        lat: -7.4100,
        lng: 109.2450,
        keliling: true
      },
      // Sate
      {
        nama: "Sate Bebek Kaleng",
        kategori: "Sate",
        alamat: "Jl. Perintis Kemerdekaan",
        jam: "16:00 - 22:00",
        harga: "Rp 20.000 - 30.000",
        deskripsi: "Sate bebek + bumbu kacang",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. Perintis Kemerdekaan",
        lat: -7.4060,
        lng: 109.2470,
        keliling: false
      },
      {
        nama: "Sate Ambal",
        kategori: "Sate",
        alamat: "Jl. Ambal",
        jam: "16:00 - 22:00",
        harga: "Rp 20.000 - 30.000",
        deskripsi: "Sate ayam bumbu kacang",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. Ambal",
        lat: -7.4040,
        lng: 109.2490,
        keliling: false
      },
      {
        nama: "Sate Kelinci",
        kategori: "Sate",
        alamat: "Jl. Karang Bolong",
        jam: "17:00 - 23:00",
        harga: "Rp 25.000 - 35.000",
        deskripsi: "Daging kelinci bumbu kecap",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. Karang Bolong",
        lat: -7.4030,
        lng: 109.2510,
        keliling: false
      },
      {
        nama: "Sate Maranggi",
        kategori: "Sate",
        alamat: "Jl. Maranggi",
        jam: "16:00 - 22:00",
        harga: "Rp 25.000 - 35.000",
        deskripsi: "Daging sapi bumbu kecap/kacang",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. Maranggi",
        lat: -7.4020,
        lng: 109.2530,
        keliling: false
      },
      {
        nama: "Sate Kambing",
        kategori: "Sate",
        alamat: "Jl. Ahmad Yani",
        jam: "17:00 - 23:00",
        harga: "Rp 25.000 - 40.000",
        deskripsi: "Daging kambing + kecap",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. Ahmad Yani",
        lat: -7.4010,
        lng: 109.2550,
        keliling: false
      },
      {
        nama: "Sate Ayam",
        kategori: "Sate",
        alamat: "Alun-Alun Purwokerto",
        jam: "17:00 - 23:00",
        harga: "Rp 15.000 - 25.000",
        deskripsi: "Ayam bumbu kacang/kecap",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Alun-Alun Purwokerto",
        lat: -7.4100,
        lng: 109.2400,
        keliling: true
      },
      // Bakso
      {
        nama: "Bakso Grabag",
        kategori: "Bakso",
        alamat: "Jl. Gatot Subroto",
        jam: "10:00 - 22:00",
        harga: "Rp 12.000 - 20.000",
        deskripsi: "Bakso urat + kaldu sapi",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. Gatot Subroto",
        lat: -7.4070,
        lng: 109.2490,
        keliling: false
      },
      {
        nama: "Bakso Mercon",
        kategori: "Bakso",
        alamat: "Jl. Jend. Sudirman",
        jam: "10:00 - 22:00",
        harga: "Rp 15.000 - 25.000",
        deskripsi: "Bakso pedas level bisa dipilih",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. Jend. Sudirman",
        lat: -7.4100,
        lng: 109.2450,
        keliling: false
      },
      {
        nama: "Bakso Tusuk",
        kategori: "Bakso",
        alamat: "Pasar Malam Purwokerto",
        jam: "18:00 - 23:00",
        harga: "Rp 1.000 - 2.000/tusuk",
        deskripsi: "Bakso kecil saus kacang",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Pasar Malam Purwokerto",
        lat: -7.4100,
        lng: 109.2400,
        keliling: true
      },
      {
        nama: "Bakso Urat",
        kategori: "Bakso",
        alamat: "Jl. S. Parman",
        jam: "10:00 - 22:00",
        harga: "Rp 15.000 - 25.000",
        deskripsi: "Bakso isi urat sapi",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. S. Parman",
        lat: -7.4120,
        lng: 109.2480,
        keliling: false
      },
      // Mie
      {
        nama: "Mie Ongklok",
        kategori: "Mie",
        alamat: "Jl. Prof. HR. Bunyamin",
        jam: "10:00 - 20:00",
        harga: "Rp 12.000 - 18.000",
        deskripsi: "Mie kuah kental tepung kanji",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. Prof. HR. Bunyamin",
        lat: -7.4090,
        lng: 109.2420,
        keliling: false
      },
      {
        nama: "Mie Lethek",
        kategori: "Mie",
        alamat: "Jl. Pahlawan",
        jam: "08:00 - 16:00",
        harga: "Rp 10.000 - 15.000",
        deskripsi: "Mie tradisional tepung singkong",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Jl. Pahlawan",
        lat: -7.4080,
        lng: 109.2430,
        keliling: false
      },
      // Makanan Berat
      {
        nama: "Empal Basah",
        kategori: "Makanan Berat",
        alamat: "Warung Empal Bu Yati",
        jam: "10:00 - 20:00",
        harga: "Rp 15.000 - 25.000",
        deskripsi: "Daging sapi kuah santan",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. HR Bunyamin",
        lat: -7.4090,
        lng: 109.2420,
        keliling: false
      },
      {
        nama: "Grombyang",
        kategori: "Makanan Berat",
        alamat: "Pasar Wage",
        jam: "06:00 - 12:00",
        harga: "Rp 15.000 - 25.000",
        deskripsi: "Nasi + kuah santan + daging",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Pasar Wage",
        lat: -7.4170,
        lng: 109.2420,
        keliling: false
      },
      {
        nama: "Nasi Penggel",
        kategori: "Makanan Berat",
        alamat: "Jl. Pemuda",
        jam: "17:00 - 23:00",
        harga: "Rp 15.000 - 25.000",
        deskripsi: "Ayam/bebek goreng + sambal",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. Pemuda",
        lat: -7.4070,
        lng: 109.2440,
        keliling: false
      },
      {
        nama: "Kupat Tahu",
        kategori: "Makanan Berat",
        alamat: "Pasar Wage",
        jam: "06:00 - 12:00",
        harga: "Rp 10.000 - 15.000",
        deskripsi: "Ketupat, tahu, tauge + bumbu",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Pasar Wage",
        lat: -7.4170,
        lng: 109.2420,
        keliling: false
      },
      {
        nama: "Rujak Cingur",
        kategori: "Makanan Berat",
        alamat: "Jl. S. Parman",
        jam: "10:00 - 18:00",
        harga: "Rp 15.000 - 20.000",
        deskripsi: "Sayur + buah + cingur sapi",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Jl. S. Parman",
        lat: -7.4120,
        lng: 109.2480,
        keliling: false
      },
      {
        nama: "Pecel Madiun",
        kategori: "Makanan Berat",
        alamat: "Jl. Merdeka",
        jam: "08:00 - 16:00",
        harga: "Rp 12.000 - 18.000",
        deskripsi: "Sayuran rebus + bumbu kacang",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. Merdeka",
        lat: -7.4200,
        lng: 109.2450,
        keliling: false
      },
      {
        nama: "Rawon",
        kategori: "Makanan Berat",
        alamat: "Jl. Jend. Gatot Subroto",
        jam: "10:00 - 20:00",
        harga: "Rp 20.000 - 30.000",
        deskripsi: "Sup daging kuah hitam keluak",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. Jend. Gatot Subroto",
        lat: -7.4070,
        lng: 109.2490,
        keliling: false
      },
      // Nasi Goreng
      {
        nama: "Nasi Goreng Mercon",
        kategori: "Nasi Goreng",
        alamat: "Jl. Dr. Angka",
        jam: "17:00 - 23:00",
        harga: "Rp 15.000 - 25.000",
        deskripsi: "Nasi goreng super pedas",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. Dr. Angka",
        lat: -7.4060,
        lng: 109.2500,
        keliling: false
      }
    ];

    // Initialize map
    const map = L.map('map').setView([-7.4212, 109.2422], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    let markers = [];
    function renderMap() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      kulinerData.forEach((item, index) => {
        const icon = item.keliling ? '🛺' : '🏠';
        const marker = L.marker([item.lat, item.lng], {
          icon: L.divIcon({ 
            html: `<div style="font-size:20px;">${icon}</div>`, 
            className: 'marker-icon', 
            iconSize: [30, 30] 
          })
        }).addTo(map)
          .bindPopup(`<b>${item.nama}</b><br>${item.kategori}`)
          .on('click', () => showDetail(index));
        markers.push(marker);
      });
    }
    function renderList(search = "", category = "") {
      const list = document.getElementById("list");
      list.innerHTML = "";
      const filteredData = kulinerData.filter(d =>
        d.nama.toLowerCase().includes(search.toLowerCase()) &&
        (category === "" || d.kategori === category)
      );
      if (filteredData.length === 0) {
        list.innerHTML = "<p style='text-align:center;'>Tidak ada hasil ditemukan</p>";
        return;
      }
      filteredData.forEach((d, i) => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <h3>${d.nama}</h3>
          <p>${d.kategori}</p>
          <small>${d.alamat}</small>
          <small>• ${d.jam} • ${d.harga}</small>
        `;
        div.onclick = () => showDetail(i);
        list.appendChild(div);
      });
    }
    function showDetail(index) {
      const item = kulinerData[index];
      const content = `
        <h3>${item.nama}</h3>
        <p><strong>Kategori:</strong> ${item.kategori}</p>
        <p><strong>Alamat:</strong> ${item.alamat}</p>
        <p><strong>Jam Operasional:</strong> ${item.jam}</p>
        <p><strong>Harga:</strong> ${item.harga}</p>
        <p><strong>Deskripsi:</strong> ${item.deskripsi}</p>
        <p><strong>Parkir:</strong> ${item.parkir}</p>
        <p><strong>Rute:</strong> ${item.rute}</p>
        <p><strong>Tipe:</strong> ${item.keliling ? 'Pedagang Keliling' : 'Warung/Toko Tetap'}</p>
        <img src="${item.foto}" alt="${item.nama}">
      `;
      document.getElementById("detailContent").innerHTML = content;
      document.getElementById("detailPopup").style.display = "block";
      map.setView([item.lat, item.lng], 15);
    }
    function closeDetail() {
      document.getElementById("detailPopup").style.display = "none";
    }
    // Google Form Modal
    function openGoogleForm() {
      document.getElementById('googleFormModal').style.display = 'block';
    }
    function closeGoogleForm() {
      document.getElementById('googleFormModal').style.display = 'none';
    }

    /*
    ================================================================
    ---------- BAGIAN LOGIKA UNTUK RAG (RETRIEVAL-AUGMENTED GENERATION) CHATBOT ----------
    ================================================================
    */

    /**
     * Bagian 1: Static Knowledge Base (KB)
     * Ini adalah "otak" dari chatbot kita. Isinya adalah data-data yang akan digunakan
     * oleh AI untuk menjawab pertanyaan. Setiap objek merepresentasikan satu "dokumen"
     * informasi. Anda bisa menambahkan data kuliner dari `kulinerData` ke sini
     * atau membuat data baru yang lebih deskriptif.
     */
    const KB = [
      {id:"info-0", title:"Apa itu LaporMangan?", text:"LaporMangan adalah sebuah platform berbasis web yang menampilkan peta persebaran kuliner UMKM di Purwokerto. Tujuannya adalah untuk membantu masyarakat menemukan kuliner favorit mereka dengan mudah dan mendukung UMKM lokal."},
      {id:"info-1", title:"Cara menggunakan peta", text:"Anda bisa mencari kuliner berdasarkan nama di kolom pencarian, atau memfilter berdasarkan kategori. Klik pada ikon di peta atau item di daftar untuk melihat detail lengkapnya."},
      {id:"info-2", title:"Rekomendasi kuliner", text:"Tentu! Purwokerto terkenal dengan Soto Sokaraja yang khas dengan bumbu kacangnya, dan juga Tempe Mendoan yang digoreng setengah matang. Untuk minuman, ada Es Dawet Ayu yang segar."},
      {id:"info-3", title:"Menambah informasi kuliner", text:"Anda dapat menambahkan informasi kuliner baru dengan menekan tombol '📋 Tambah Informasi'. Ini akan membuka Google Form di mana Anda bisa mengisi detail kuliner yang ingin Anda laporkan."},
      ...kulinerData.map((item, index) => ({
        id: `kuliner-${index}`,
        title: item.nama,
        text: `Nama kuliner: ${item.nama}. Kategori: ${item.kategori}. Alamat: ${item.alamat}. Jam buka: ${item.jam}. Kisaran harga: ${item.harga}. Deskripsi: ${item.deskripsi}. Tipe: ${item.keliling ? 'Pedagang Keliling' : 'Warung/Toko Tetap'}.`
      }))
    ];

    /**
     * Bagian 2: Fungsi Retrieval Sederhana
     * Fungsi ini bertugas untuk "mengambil" (retrieve) dokumen dari Knowledge Base (KB)
     * yang paling relevan dengan pertanyaan pengguna.
     * Cara kerjanya sederhana: memecah pertanyaan menjadi kata-kata, lalu mencari
     * dokumen di KB yang mengandung kata-kata tersebut.
     * @param {string} question - Pertanyaan dari pengguna.
     * @param {number} k - Jumlah dokumen teratas yang ingin diambil (default 3).
     * @returns {Array<Object>} - Array berisi dokumen yang relevan.
     */
    function retrieve(question, k=3){
      const terms = question.toLowerCase().split(/\s+/); // Pecah pertanyaan jadi kata-kata
      return KB.filter(doc =>
        // Cek apakah ada kata dari pertanyaan yang cocok dengan judul atau teks dokumen
        terms.some(t => doc.text.toLowerCase().includes(t) ||
                        doc.title.toLowerCase().includes(t))
      ).slice(0,k); // Ambil 'k' dokumen teratas
    }

    /**
     * Bagian 3: Pemanggilan API Gemini
     * Fungsi ini yang akan berkomunikasi dengan model AI Google (Gemini).
     * Ia mengirimkan prompt (yang sudah kita siapkan) ke API dan mengembalikan jawaban dari AI.
     * PENTING: Ganti `YOUR_GEMINI_API_KEY` dengan kunci API Anda.
     */
    const ENDPOINT = "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent";
    let API_KEY = "AIzaSyDJfUcm5OEoHK5FhVO_UMIYS8g52r4ar0A"; // ‼️ Kunci API disisipkan di sini. PERINGATAN: Kunci ini terlihat di sisi klien. Untuk produksi, gunakan backend proxy.

    async function askGemini(prompt){
      // Peringatan keamanan: Kode ini sebelumnya meminta kunci API kepada pengguna.
      // Sekarang kunci tersebut di-hardcode untuk kemudahan.
      // JANGAN LAKUKAN INI DI LINGKUNGAN PRODUKSI.
      // Kunci API yang diekspos di frontend dapat disalahgunakan.
      // if (API_KEY === "YOUR_GEMINI_API_KEY" || !API_KEY) {
      //   const userInputKey = prompt("Silakan masukkan Gemini API Key Anda untuk mengaktifkan AI Assistant:");
      //   if (userInputKey) {
      //     API_KEY = userInputKey;
      //   } else {
      //     return "Maaf, API Key diperlukan untuk menggunakan fitur AI. Anda bisa mendapatkannya dari Google AI Studio.";
      //   }
      // }

      try {
        const res = await fetch(`${ENDPOINT}?key=${API_KEY}`,{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body:JSON.stringify({
            contents:[{parts:[{text:prompt}]}]
          })
        });

        if (!res.ok) {
          // Tangani respons error dari API (misal: API key salah)
          const errorBody = await res.json();
          console.error("API Error:", errorBody);
          return `Maaf, terjadi kesalahan saat menghubungi AI. (${errorBody.error?.message || 'Status: ' + res.status})`;
        }

        const json = await res.json();
        
        // Cek jika tidak ada kandidat jawaban atau konten diblokir
        if (!json.candidates || json.candidates.length === 0 || !json.candidates[0].content) {
            console.warn("API Response Warning:", json);
            return "Maaf, saya tidak bisa memberikan jawaban untuk pertanyaan tersebut saat ini. Mungkin karena alasan keamanan atau filter konten.";
        }

        // Ekstrak dan kembalikan teks jawaban dari respons JSON
        return json.candidates[0].content.parts[0].text;

      } catch (error) {
        // Tangani error jaringan atau error lainnya
        console.error("Fetch Error:", error);
        return "Maaf, sepertinya ada masalah dengan koneksi. Coba periksa kembali API Key dan koneksi internet Anda.";
      }
    }

    /**
     * Bagian 4: Fungsi Bantuan untuk UI (User Interface) Chat
     * Fungsi-fungsi ini membantu mengelola tampilan chat.
     */
    const ragChat = document.getElementById("rag-chat-messages");

    // Fungsi untuk menambahkan pesan baru ke jendela chat
    function addRagMsg(txt, cls){
      const div=document.createElement("div");
      div.className=`rag-msg ${cls}`;
      div.textContent=txt;
      ragChat.append(div);
      ragChat.scrollTop=ragChat.scrollHeight; // Auto-scroll ke pesan terbaru
    }

    // Fungsi untuk membuat prompt yang akan dikirim ke Gemini
    function makePrompt(question, docs){
      // Gabungkan teks dari dokumen yang relevan sebagai konteks
      const ctx = docs.map(d=>`• ${d.title}: ${d.text}`).join("\n");
      // Buat prompt lengkap dengan instruksi, konteks, dan pertanyaan
      return `Anda adalah "ManganBot", asisten AI yang ramah untuk aplikasi "LaporMangan". Gunakan konteks berikut untuk menjawab pertanyaan pengguna seputar kuliner di Purwokerto. Jawab dengan singkat, jelas, dan dalam Bahasa Indonesia.\n\nKonteks:\n${ctx}\n\nPertanyaan: ${question}\nJawaban:`;
    }
    
    // Fungsi untuk membuka/menutup popup chat
    function toggleRagChat() {
      const chatPopup = document.getElementById("ragChatPopup");
      const isHidden = !chatPopup.style.display || chatPopup.style.display === "none";
      chatPopup.style.display = isHidden ? "flex" : "none";
      if (isHidden) {
        document.getElementById("rag-q").focus();
      }
    }

    /**
     * Bagian 5: Event Handler untuk Form Chat
     * Ini adalah inti dari interaksi pengguna. Ketika pengguna mengirim pesan...
     */
    document.getElementById("rag-chat-form").addEventListener("submit", async e => {
      e.preventDefault(); // Mencegah form dari reload halaman
      const q = e.target['rag-q'].value.trim(); // Ambil teks pertanyaan
      if(!q) return; // Jangan lakukan apa-apa jika input kosong

      addRagMsg(q, "rag-user"); // Tampilkan pesan pengguna di chat
      e.target['rag-q'].value = ""; // Kosongkan input field
      
      const typingIndicator = addRagMsg("Mengetik...", "rag-bot"); // Tampilkan indikator "mengetik"

      try {
        const docs = retrieve(q); // 1. Ambil dokumen relevan dari KB
        const prompt = makePrompt(q, docs); // 2. Buat prompt untuk AI
        const answer = await askGemini(prompt); // 3. Kirim prompt ke Gemini dan tunggu jawaban

        // Ganti indikator "mengetik" dengan jawaban dari AI
        ragChat.querySelector(".rag-bot:last-child").textContent = answer;

      } catch (error) {
        // Jika terjadi error di salah satu langkah, tampilkan pesan error
        console.error("Chat Handler Error:", error);
        ragChat.querySelector(".rag-bot:last-child").textContent = "Waduh, ada yang salah nih. Coba lagi ya.";
      }
    });
    // Rekomendasi Cuaca berbasis API
    async function fetchWeather() {
      try {
        // Ganti YOUR_API_KEY dengan API key OpenWeatherMap Anda
        const API_KEY = 'YOUR_API_KEY'; // <-- Masukkan API key Anda di sini
        const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=Purwokerto,id&appid=${API_KEY}&units=metric&lang=id`);
        
        if (!response.ok) {
          throw new Error('Gagal mengambil data cuaca');
        }
        
        const data = await response.json();
        
        // Update UI
        document.getElementById("weatherTemp").textContent = `${Math.round(data.main.temp)}°C`;
        document.getElementById("weatherDetailsTemp").textContent = `${Math.round(data.main.temp)}°C`;
        document.getElementById("weatherMinTemp").textContent = `${Math.round(data.main.temp_min)}°C`;
        document.getElementById("weatherMaxTemp").textContent = `${Math.round(data.main.temp_max)}°C`;
        document.getElementById("weatherHumidity").textContent = `${data.main.humidity}%`;
        document.getElementById("weatherWind").textContent = `${data.wind.speed} m/s`;
        document.getElementById("weatherDetailsDesc").textContent = data.weather[0].description;
        
        // Set icon
        const iconCode = data.weather[0].icon;
        const iconUrl = `https://openweathermap.org/img/wn/${iconCode}@2x.png`;
        document.getElementById("weatherIcon").outerHTML = `<img src="${iconUrl}" class="weather-icon" style="width:20px;height:20px;">`;
        document.getElementById("weatherDetailsIcon").outerHTML = `<img src="${iconUrl}" class="weather-details-icon" style="width:40px;height:40px;">`;
        
        // Update tanggal
        const today = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById("weatherDate").textContent = today.toLocaleDateString('id-ID', options);
        
      } catch (error) {
        console.error('Error fetching weather:', error);
        // Fallback ke data simulasi jika API gagal
        simulateWeather();
      }
    }
    
    // Fungsi simulasi cuaca (fallback)
    function simulateWeather() {
      console.log("Menggunakan data cuaca simulasi");
      const weatherData = {
        temp: 28,
        minTemp: 22,
        maxTemp: 32,
        humidity: 75,
        wind: 2.5,
        description: "Berawan",
        icon: "fa-cloud-sun"
      };
      
      document.getElementById("weatherTemp").textContent = `${weatherData.temp}°C`;
      document.getElementById("weatherDetailsTemp").textContent = `${weatherData.temp}°C`;
      document.getElementById("weatherMinTemp").textContent = `${weatherData.minTemp}°C`;
      document.getElementById("weatherMaxTemp").textContent = `${weatherData.maxTemp}°C`;
      document.getElementById("weatherHumidity").textContent = `${weatherData.humidity}%`;
      document.getElementById("weatherWind").textContent = `${weatherData.wind} m/s`;
      document.getElementById("weatherDetailsDesc").textContent = weatherData.description;
      document.getElementById("weatherIcon").className = `fas ${weatherData.icon} weather-icon`;
      document.getElementById("weatherDetailsIcon").className = `fas ${weatherData.icon} weather-details-icon`;
      
      const today = new Date();
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById("weatherDate").textContent = today.toLocaleDateString('id-ID', options);
    }
    
    function toggleWeatherDetails() {
      const details = document.getElementById("weatherDetails");
      details.classList.toggle("show");
    }
    
    // Rekomendasi cuaca berdasarkan data API
    function showWeatherRec() {
      // Pastikan data cuaca sudah dimuat
      fetchWeather().then(() => {
        // Setelah data cuaca dimuat, tampilkan rekomendasi
        setTimeout(() => {
          const tempElement = document.getElementById("weatherTemp");
          if (tempElement && tempElement.textContent !== "--°C") {
            const temp = parseInt(tempElement.textContent);
            let recommendation = "";
            
            if (temp < 20) {
              recommendation = "Hari ini sedikit dingin, cocok menikmati Soto hangat seperti Soto Sokaraja atau Soto Bening!";
            } else if (temp >= 20 && temp <= 25) {
              recommendation = "Cuaca hari ini nyaman, pas untuk mencoba kuliner baru seperti Tempe Mendoan atau Tahu Gejrot!";
            } else if (temp > 25 && temp <= 30) {
              recommendation = "Hari ini cukup panas, cocok menikmati minuman segar seperti Es Dawet Ayu atau Es Cendol Dawet!";
            } else {
              recommendation = "Hari ini sangat panas, segeralah dengan minuman segar atau camilan dingin seperti Es Puter!";
            }
            
            // Tampilkan rekomendasi di chatbot AI
            addRagMsg(`🌤️ Rekomendasi Cuaca: ${recommendation}`, "rag-bot");
            
            // Jika chatbot belum terbuka, buka dulu
            const chatPopup = document.getElementById("ragChatPopup");
            if (!chatPopup.style.display || chatPopup.style.display === "none") {
              toggleRagChat();
            }
          } else {
            // Jika data cuaca belum tersedia, beri pesan fallback
            addRagMsg("🌤️ Rekomendasi Cuaca: Cuaca hari ini sangat cocok untuk menikmati kuliner Purwokerto! Coba cari Soto Sokaraja atau Tempe Mendoan.", "rag-bot");
            
            const chatPopup = document.getElementById("ragChatPopup");
            if (!chatPopup.style.display || chatPopup.style.display === "none") {
              toggleRagChat();
            }
          }
        }, 500); // Tunggu sebentar setelah fetchWeather selesai
      });
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      renderMap();
      renderList();
      
      // Coba fetch data cuaca dari API, fallback ke simulasi jika gagal
      fetchWeather();
      
      document.getElementById("search").addEventListener("input", (e) => {
        const search = e.target.value;
        const category = document.getElementById("filter").value;
        renderList(search, category);
      });
      document.getElementById("filter").addEventListener("change", (e) => {
        const search = document.getElementById("search").value;
        const category = e.target.value;
        renderList(search, category);
      });
      
      // Menambahkan pesan selamat datang di RAG Chatbot saat halaman dimuat
      addRagMsg("Halo! Aku ManganBot 🤖 Ada yang bisa dibantu seputar kuliner Purwokerto?", "rag-bot");

      // Close modals when clicking outside
      window.addEventListener('click', (event) => {
        const googleModal = document.getElementById('googleFormModal');
        if (event.target === googleModal) {
          closeGoogleForm();
        }
      });
    });
  </script>
</body>
</html>
