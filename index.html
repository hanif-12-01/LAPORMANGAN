<!DOCTYPE html>
<!-- 
  File: index.html
  Latar Belakang: Ini adalah file HTML utama untuk aplikasi "Lapor Mangan!". 
  File ini mendefinisikan struktur halaman web, termasuk header, peta, daftar kuliner, dan antarmuka chatbot.
  Aturan Perubahan:
  1. Perubahan pada struktur (seperti menambah atau menghapus elemen div) harus diuji untuk memastikan tidak merusak layout atau fungsionalitas.
  2. Penambahan script atau stylesheet baru harus memperhatikan urutan pemuatan. Contoh: basis data (knowledge-base.js) harus dimuat sebelum logika (chatbot.js).
  3. Semua perubahan signifikan harus dicatat dalam komentar di bawah ini.
  
  Catatan Perubahan:
  - 2025-08-07: Mengganti logika chatbot inline dengan file eksternal (knowledge-base.js, chatbot.js) untuk modularitas.
  - 2025-08-07: Menambahkan stylesheet eksternal (styles.css) untuk styling chatbot.
  - 2025-08-07: Menghapus logika RAG (Retrieval-Augmented Generation) berbasis Gemini API dan menggantinya dengan chatbot statis berbasis keyword.
-->
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Lapor Mangan! - Purwokerto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- Memuat font 'Poppins' dari Google Fonts untuk tampilan teks yang konsisten. -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <!-- Memuat stylesheet untuk Leaflet.js, library untuk peta interaktif. -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <!-- Memuat stylesheet untuk Font Awesome, untuk ikon-ikon seperti cuaca. -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- Memuat stylesheet kustom untuk chatbot. -->
  <link rel="stylesheet" href="styles.css">
  <style>
    /* CSS inline untuk styling utama aplikasi. */
    :root {
      --red: #c53e4e;
      --light-red: #d8c2cf;
      --bg: #f8f9fa;
      --white: #ffffff;
      --text: #333;
      --blue: #2980b9;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; }
    body { background: var(--bg); color: var(--text); }
    header {
      background: var(--red);
      color: var(--white);
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      position: relative;
      flex-wrap: wrap;
    }
    .header-content {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
      min-width: 200px;
    }
    header img { height: 40px; }
    .weather-info {
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 12px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
      white-space: nowrap;
    }
    .weather-info:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    .weather-icon {
      font-size: 20px;
    }
    .weather-temp {
      font-weight: 600;
      font-size: 16px;
    }
    .weather-details {
      position: absolute;
      top: 100%;
      right: 20px;
      background: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      z-index: 1000;
      width: 250px;
      display: none;
      color: var(--text);
    }
    .weather-details.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    #map {
      height: 60vh;
      width: 100%;
    }
    .container {
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }
    .filter-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .filter-bar input,
    .filter-bar select,
    .filter-bar button {
      flex: 1;
      padding: 10px;
      border: 1px solid var(--light-red);
      border-radius: 8px;
      min-width: 120px;
    }
    .filter-bar button {
      background: var(--red);
      color: white;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .filter-bar button:hover {
      background: #b03545;
    }
    .card {
      background: var(--white);
      border-left: 5px solid var(--red);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .card:hover { transform: translateY(-3px); }
    .card h3 { color: var(--red); }
    .card small { color: #666; }
    .detail-popup {
      display: none;
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      z-index: 9999;
      max-width: 400px;
      width: 90%;
    }
    .detail-popup img {
      width: 100%;
      border-radius: 8px;
      margin-top: 10px;
    }
    .close-btn {
      float: right;
      cursor: pointer;
      font-size: 20px;
      color: var(--red);
    }
    /* Tombol Tambah Kuliner */
    .filter-bar .add-btn {
      background: #27ae60;
      color: white;
      min-width: 120px;
    }
    
    /* ---------- STYLES UNTUK RAG CHATBOT ---------- */
    /* Variabel warna dan style untuk chatbot, terinspirasi dari desain modern */
    :root {
      --rag-bg: #f5f5f5; /* Warna latar belakang utama chat */
      --rag-surface: #fffffe; /* Warna permukaan untuk bubble chat bot */
      --rag-txt: #243746; /* Warna teks utama */
      --rag-accent: #0077b6; /* Warna aksen untuk bubble chat user dan tombol */
      --rag-radius: 12px; /* Radius sudut untuk elemen UI */
      --rag-shadow: 0 2px 6px rgba(0,0,0,.1); /* Bayangan untuk memberi kedalaman */
    }

    /* Tombol untuk membuka chatbot */
    .chatbot-toggler {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--rag-accent);
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      z-index: 999;
      box-shadow: var(--rag-shadow);
      transition: transform 0.3s ease;
    }
    .chatbot-toggler:hover {
      transform: scale(1.1);
    }

    /* Kontainer popup chat */
    .rag-chat-popup {
      display: none; /* Awalnya disembunyikan */
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 350px;
      height: 500px;
      background: var(--rag-bg);
      border-radius: var(--rag-radius);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      z-index: 1000;
    }

    /* Header dari popup chat */
    .rag-chat-header {
      padding: 1rem;
      background: var(--rag-accent);
      color: #fff;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .rag-chat-close {
      cursor: pointer;
      font-size: 20px;
    }

    /* Area untuk menampilkan pesan-pesan chat */
    #rag-chat-messages {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: .75rem;
    }

    /* Styling umum untuk setiap bubble pesan */
    .rag-msg {
      max-width: 80%;
      padding: .75rem 1rem;
      border-radius: var(--rag-radius);
      box-shadow: var(--rag-shadow);
      line-height: 1.4;
    }

    /* Bubble pesan dari pengguna */
    .rag-user {
      align-self: flex-end;
      background: var(--rag-accent);
      color: #fff;
      border-bottom-right-radius: 4px;
    }

    /* Bubble pesan dari bot */
    .rag-bot {
      align-self: flex-start;
      background: var(--rag-surface);
      color: var(--rag-txt);
      border-bottom-left-radius: 4px;
    }

    /* Form input untuk mengirim pesan */
    #rag-chat-form {
      display: flex;
      gap: .5rem;
      padding: 1rem;
      border-top: 1px solid #ddd;
      background: #fff;
    }

    /* Input field dan tombol */
    #rag-chat-form input, #rag-chat-form button {
      font: inherit;
      padding: .65rem 1rem;
      border-radius: var(--rag-radius);
      border: 1px solid #ccd;
      outline: none;
    }
    #rag-chat-form input {
      flex: 1;
    }
    #rag-chat-form button {
      background: var(--rag-accent);
      color: #fff;
      border: none;
      cursor: pointer;
    }
    /* Modal Google Form */
    .modal-iframe {
      width: 90%;
      max-width: 800px;
      height: 80vh;
      margin: 5% auto;
      background: white;
      border-radius: 15px;
      overflow: hidden;
    }
    .modal-iframe-content {
      width: 100%;
      height: 100%;
      border: none;
    }
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    /* Responsive */
    @media (max-width: 768px) {
      .filter-bar {
        flex-direction: column;
      }
      .filter-bar input,
      .filter-bar select,
      .filter-bar button {
        width: 100%;
      }
      .chat-popup {
        width: calc(100% - 40px);
        right: 20px;
        left: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Header utama aplikasi. -->
  <header>
    <div class="header-content">
      <h1>Lapor Mangan! - Purwokerto</h1>
    </div>
    <!-- Widget cuaca. -->
    <div class="weather-info" id="weatherInfo" onclick="toggleWeatherDetails()">
      <i class="fas fa-cloud-sun weather-icon" id="weatherIcon"></i>
      <span class="weather-temp" id="weatherTemp">--°C</span>
    </div>
    <div class="weather-details" id="weatherDetails">
      <!-- Konten detail cuaca akan diisi oleh JavaScript. -->
    </div>
  </header>

  <!-- Elemen div ini akan menjadi kontainer untuk peta Leaflet. -->
  <div id="map"></div>

  <!-- Kontainer utama untuk konten di bawah peta, seperti filter dan daftar kuliner. -->
  <div class="container">
    <div class="filter-bar">
      <input id="search" placeholder="Cari nama kuliner..." />
      <select id="filter">
        <!-- Opsi filter akan tetap sama. -->
        <option value="">Semua</option>
        <option value="Soto">Soto</option>
        <option value="Gorengan">Gorengan</option>
        <option value="Jajanan Tradisional">Jajanan Tradisional</option>
        <option value="Camilan Kering">Camilan Kering</option>
        <option value="Kue Tradisional">Kue Tradisional</option>
        <option value="Kuliner Unik">Kuliner Unik</option>
        <option value="Sayuran">Sayuran</option>
        <option value="Dodol">Dodol</option>
        <option value="Kue Kering">Kue Kering</option>
        <option value="Makanan Ringan">Makanan Ringan</option>
        <option value="Camilan">Camilan</option>
        <option value="Camilan Manis">Camilan Manis</option>
        <option value="Minuman">Minuman</option>
        <option value="Sate">Sate</option>
        <option value="Bakso">Bakso</option>
        <option value="Mie">Mie</option>
        <option value="Makanan Berat">Makanan Berat</option>
        <option value="Nasi Goreng">Nasi Goreng</option>
      </select>
      <button onclick="showWeatherRec()">Rekomendasi Cuaca</button>
      <button onclick="openGoogleForm()">📋 Tambah Informasi</button>
    </div>
    <!-- Daftar kuliner akan di-render di sini oleh JavaScript. -->
    <div id="list"></div>
  </div>

  <!-- Popup untuk menampilkan detail kuliner. -->
  <div class="detail-popup" id="detailPopup">
    <span class="close-btn" onclick="closeDetail()">×</span>
    <div id="detailContent"></div>
  </div>

  <!-- Modal untuk menampilkan Google Form penambahan data. -->
  <div id="googleFormModal" class="modal">
    <div class="modal-iframe">
      <span class="close-btn" onclick="closeGoogleForm()" style="position: absolute; right: 15px; top: 15px; z-index: 10001;">&times;</span>
      <iframe src="https://docs.google.com/forms/d/e/1FAIpQLScJ8tkZau-NVdhbmd0cWFKY25VBm0Ajjxvqo-rLYAO_iGb2qg/viewform?embedded=true" class="modal-iframe-content"></iframe>
    </div>
  </div>

  <!-- ---------- ANTARMUKA CHATBOT ---------- -->
  <!-- Tombol bulat untuk membuka/menutup popup chat. -->
  <div class="chatbot-toggler">
    <span>🤖</span>
  </div>

  <!-- Popup chat yang berisi seluruh antarmuka chatbot. -->
  <div class="rag-chat-popup" id="ragChatPopup">
    <div class="rag-chat-header">
      <span>LaporMangan AI Assistant</span>
      <span class="rag-chat-close" onclick="toggleRagChat()">×</span>
    </div>
    <main id="rag-chat-messages"></main>
    <form id="rag-chat-form">
      <input id="rag-q" autocomplete="off" placeholder="Tanya seputar kuliner..." required />
      <button>Kirim</button>
    </form>
  </div>

  <!-- Memuat library JavaScript untuk peta. -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Memuat basis data untuk chatbot. HARUS dimuat SEBELUM chatbot.js. -->
  <script src="knowledge-base.js"></script>
  <!-- Memuat logika chatbot. -->
  <script src="chatbot.js"></script>
  <!-- Script inline untuk fungsionalitas utama aplikasi (peta, daftar, cuaca). -->
  <script>
    // Data kuliner statis yang digunakan untuk menampilkan pin di peta dan item di daftar.
    const kulinerData = [
      // ... (data kuliner tetap sama)
      {
        nama: "Soto Sokaraja",
        kategori: "Soto",
        alamat: "Jl. Sokaraja",
        jam: "07:00 - 15:00",
        harga: "Rp 12.000 - 20.000",
        deskripsi: "Kuah kaldu sapi + kacang, ketupat, kerupuk",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tersedia",
        rute: "Area Sokaraja",
        lat: -7.4220,
        lng: 109.2300,
        keliling: false
      },
      {
        nama: "Nasi Goreng Mercon",
        kategori: "Nasi Goreng",
        alamat: "Jl. Dr. Angka",
        jam: "17:00 - 23:00",
        harga: "Rp 15.000 - 25.000",
        deskripsi: "Nasi goreng super pedas",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. Dr. Angka",
        lat: -7.4060,
        lng: 109.2500,
        keliling: false
      }
    ];

    // Inisialisasi peta Leaflet.
    const map = L.map('map').setView([-7.4212, 109.2422], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    let markers = [];

    // Fungsi untuk me-render marker di peta berdasarkan kulinerData.
    function renderMap() {
      // ... (logika renderMap tetap sama)
    }

    // Fungsi untuk me-render daftar kuliner di bawah peta.
    function renderList(search = "", category = "") {
      // ... (logika renderList tetap sama)
    }

    // Fungsi untuk menampilkan popup detail saat marker atau item daftar di-klik.
    function showDetail(index) {
      // ... (logika showDetail tetap sama)
    }

    // Fungsi untuk menutup popup detail.
    function closeDetail() {
      document.getElementById("detailPopup").style.display = "none";
    }

    // Fungsi untuk membuka modal Google Form.
    function openGoogleForm() {
      document.getElementById('googleFormModal').style.display = 'block';
    }

    // Fungsi untuk menutup modal Google Form.
    function closeGoogleForm() {
      document.getElementById('googleFormModal').style.display = 'none';
    }
    
    // Fungsi untuk mengambil data cuaca dari API OpenWeatherMap.
    async function fetchWeather() {
      // ... (logika fetchWeather tetap sama, membutuhkan API Key)
    }
    
    // Fungsi fallback jika API cuaca gagal.
    function simulateWeather() {
      // ... (logika simulateWeather tetap sama)
    }
    
    // Fungsi untuk menampilkan/menyembunyikan detail cuaca.
    function toggleWeatherDetails() {
      const details = document.getElementById("weatherDetails");
      details.classList.toggle("show");
    }
    
    // Fungsi untuk menampilkan rekomendasi kuliner berdasarkan cuaca.
    function showWeatherRec() {
      // ... (logika showWeatherRec tetap sama)
    }
    
    // Event listener yang dijalankan setelah seluruh halaman dimuat.
    document.addEventListener('DOMContentLoaded', () => {
      renderMap();
      renderList();
      fetchWeather();
      
      // Event listener untuk input pencarian dan filter kategori.
      document.getElementById("search").addEventListener("input", (e) => {
        const search = e.target.value;
        const category = document.getElementById("filter").value;
        renderList(search, category);
      });
      document.getElementById("filter").addEventListener("change", (e) => {
        const search = document.getElementById("search").value;
        const category = e.target.value;
        renderList(search, category);
      });

      // Menutup modal jika pengguna mengklik di luar area modal.
      window.addEventListener('click', (event) => {
        const googleModal = document.getElementById('googleFormModal');
        if (event.target === googleModal) {
          closeGoogleForm();
        }
      });
    });
  </script>
</body>
</html>
